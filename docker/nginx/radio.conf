server {
    listen 80 fastopen=200 default_server;
    listen 443 fastopen=200 ssl http2;
    access_log off;

    include snippets/ssl.conf;

    ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
    ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;

    include snippets/security-headers.conf;

    root /web;
    index index.html;
    server_name _;

    proxy_connect_timeout       60;
    proxy_read_timeout          120;
    max_ranges 1;
    tcp_nodelay on;

    gzip on;
    gzip_types text/html text/css text/xml text/plain text/javascript text/xml application/xml application/x-javascript application/javascript application/json image/svg+xml application/font-woff application/font-woff2 application/font-ttf;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_disable "MSIE [1-6]\.";

    real_ip_header X-Forwarded-For;
    set_real_ip_from 0.0.0.0/0;

    location ^~ /mnt {
        internal;
        root /;
        sendfile       on;
        tcp_nopush     on;
        add_header Cache-Control "public, max-age=172800, immutable";
        add_header Vary "Cookie, Content-Encoding";
        add_header Last-Modified "";
        #add_header Accept-Ranges bytes;
        if_modified_since off;
        etag off;

        include snippets/security-headers.conf;
        include snippets/cors.conf;
        gzip off;
    }

    location ^~ /api/tag/ {
        deny all;
    }

    location / {
        try_files $uri $uri/ =404;

        location ~* \.(jpg|jpeg|png|gif|svg|ico|css|js|woff|woff2|ttf|ttc|map|wasm|data)$ {
            add_header Cache-Control "public, max-age=172800";
            gzip on;
            sendfile on;
            include snippets/security-headers.conf;
        }

        location ^~ /userscript/ {
            add_header Cache-Control "no-store";
            gzip on;
            sendfile on;
            include snippets/security-headers.conf;
        }
    }

    location /shares {
        autoindex off;
        alias /shares;
        try_files $uri $uri/ =404;
        sendfile on;
        add_header Cache-Control "public, max-age=3600";
        include snippets/security-headers.conf;
    }

    location ^~ /.well-known/dnt/ {
        rewrite ^ "/help.html#privacy" permanent;
    }

    location = /.well-known/dnt-policy.txt {
        rewrite ^ "/help.html#privacy" permanent;
    }

    location = / {
        include fastcgi_params;
        fastcgi_param   SCRIPT_FILENAME  /web/bin/index.php;
        fastcgi_param   QUERY_STRING     $query_string;
        fastcgi_param   REQUEST_METHOD   $request_method;
        fastcgi_param   CONTENT_TYPE     $content_type;
        fastcgi_param   CONTENT_LENGTH   $content_length;

        fastcgi_param   HTTP_X_NONCE     $request_id;

        fastcgi_pass fpm:9000;
        include snippets/security-headers.conf;
    }


    location ^~ /import {
        include fastcgi_params;
        fastcgi_param   SCRIPT_FILENAME  /web/bin/import.php;
        fastcgi_param   QUERY_STRING     $query_string;
        fastcgi_param   REQUEST_METHOD   $request_method;
        fastcgi_param   CONTENT_TYPE     $content_type;
        fastcgi_param   CONTENT_LENGTH   $content_length;

        fastcgi_param   HTTP_X_NONCE $request_id;

        fastcgi_pass fpm:9000;
        include snippets/security-headers-unsafe.conf;


    }



    location ^~ /import/lastfm {
        include fastcgi_params;
        fastcgi_param   SCRIPT_FILENAME  /web/bin/lastfm.php;
        fastcgi_param   QUERY_STRING     $query_string;
        fastcgi_param   REQUEST_METHOD   $request_method;
        fastcgi_param   CONTENT_TYPE     $content_type;
        fastcgi_param   CONTENT_LENGTH   $content_length;

        fastcgi_param   HTTP_X_NONCE $request_id;

        fastcgi_pass fpm:9000;

        include snippets/security-headers.conf;
    }


    location ^~ /player/ {
        include fastcgi_params;
        fastcgi_param   SCRIPT_FILENAME  /web/bin/player.php;
        fastcgi_param   QUERY_STRING     $query_string;
        fastcgi_param   REQUEST_METHOD   $request_method;
        fastcgi_param   CONTENT_TYPE     $content_type;
        fastcgi_param   CONTENT_LENGTH   $content_length;

        fastcgi_param   HTTP_X_NONCE $request_id;

        fastcgi_pass fpm:9000;

        include snippets/security-headers-unsafe.conf;


    }

    location ^~ /service/encode/ {
        include fastcgi_params;
        fastcgi_param   SCRIPT_FILENAME  /web/bin/transcode.php;
        fastcgi_param   QUERY_STRING     $query_string;
        fastcgi_param   REQUEST_METHOD   $request_method;
        fastcgi_param   CONTENT_TYPE     $content_type;
        fastcgi_param   CONTENT_LENGTH   $content_length;

        fastcgi_param   HTTP_X_NONCE $request_id;

        fastcgi_pass fpm:9000;

        include snippets/security-headers-unsafe.conf;


    }

    location = /help.html {
        try_files $uri $uri/ =404;
        add_header Cache-Control "public, max-age=180";
        include snippets/security-headers.conf;
    }


    location ^~ /api/ {
        proxy_pass http://api:8011;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        add_header Cache-Control "no-store";
        add_header Allow "HEAD, OPTIONS, GET, POST";

        include snippets/security-headers.conf;
    }

    location ^~ /api/download/ {
        proxy_pass http://api:8011;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        limit_conn downloads 10;

        include snippets/security-headers.conf;
        include snippets/cors.conf;
        add_header Cache-Control "public, max-age=172800, immutable";
        add_header Vary "Cookie, Content-Encoding";
        add_header Last-Modified "";
        if_modified_since off;
        etag off;
    }

    location ^~ /api/cover/ {
        proxy_pass http://api:8011;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        add_header Cache-Control "public, max-age=172800, immutable";

        include snippets/security-headers.conf;
        include snippets/cors.conf;
    }



    location ^~ /api/events/ {
        proxy_pass http://api:8011;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
        add_header Cache-Control "no-store";
        include snippets/security-headers.conf;
    }


    location ^~ /stream/bypass/ {
        proxy_http_version 1.1;
        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-Host "";
        proxy_set_header X-Forwarded-Server "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header chrome-proxy "";
        proxy_set_header Range "";
        proxy_set_header DNT "";
        proxy_set_header Referer "";
        proxy_set_header Accept-Encoding "";

        proxy_connect_timeout 10080s;
        proxy_send_timeout 10080;
        proxy_read_timeout 10080;
        proxy_redirect off;
        proxy_buffering off;
        proxy_request_buffering off;
        chunked_transfer_encoding off;

        proxy_pass http://kawa:8001/;

        add_header Content-Type "text/html";

        include snippets/security-headers.conf;
    }

    location ^~ /stream/ {
        proxy_http_version 1.1;
        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-Host "";
        proxy_set_header X-Forwarded-Server "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header chrome-proxy "";
        proxy_set_header Range "";
        proxy_set_header DNT "";
        proxy_set_header Referer "";
        proxy_set_header Accept-Encoding "";

        proxy_connect_timeout 10080s;
        proxy_send_timeout 10080;
        proxy_read_timeout 10080;
        proxy_redirect off;
        proxy_buffering off;
        proxy_request_buffering on;
        chunked_transfer_encoding off;

        proxy_pass http://kawa:8001/;

        add_header Vary "*";

        include snippets/security-headers.conf;

    }

}

